{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PolyLink</title>
  <link rel="stylesheet" href={% static "styles/home.css" %} />
  <link rel="stylesheet" href={% static "styles/notifications.css" %} />
  <link rel="stylesheet" href={% static "styles/bootstrap-icons.css" %} />
  <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
  <style>
    @font-face {
      font-family: "Bootstrap Font";
      src: url({% static "styles/fonts/bootstrap-icons.woff" %}) format("woff"), 
          url({% static "styles/fonts/bootstrap-icons.woff2" %}) format("woff2");
    }
  </style>
  <script defer src={% static "scripts/home.js" %}></script>
  <script defer src={% static "scripts/notifications.js" %}></script>
</head>
<body>
  <header class="navbar">
    <div class="logo">PolyLink</div>
    <div class="search-bar">
      <i class="bi bi-search search-icon"></i>
      <input type="text" placeholder="Search for creators, inspirations, and projects" />
    </div>
    <div class="logout-avatar">
      <a href="{% url "users:logout" %}">
        <button class="button logout-btn">Log out</button>
      </a>
      <a href={% url "users:profile" id=user.id %}>
        <div class="avatar small">
            <img src={% url "users:avatar" id=user.id %} alt="profil">
        </div>
      </a>
    </div>
  </header>

  <main class="container">
    <aside class="sidebar">
      <a href={% url "users:profile" id=user.id %}>
        <div class="profile">
          <div class="avatar">
            <img src={% url "users:avatar" id=user.id %} alt="profil">
          </div>
          <div class="infos">
            <h4>{{user.first_name}} {{user.last_name}}</h4>
            <p>@{{user.username}}</p>
          </div>
        </div>
      </a>
      <nav>
        <a href={% url "users:home" %} class="active"><i class="bi bi-house-heart"></i>
          <p>Home</p>
        </a>
        <a href={% url "users:explore" %}><i class="bi bi-compass"></i>
          <p>Explore</p>
        </a>
        <!-- Section notifications dans la navigation --> 
        <div class="nav-item notifications-container">
            <a href="#" class="notifications-link nav-link">
                <i class="bi bi-bell"></i>
                {% if unread_notifications_count > 0 %}
                    <span class="badge">{{ unread_notifications_count }}</span>
                {% endif %}
                <p>Notifications</p>
            </a>

            <!-- Dropdown des notifications -->
            <div class="notifications-dropdown">
                <div class="notifications-header">
                    <h4>Notifications récentes</h4>
                    {% if unread_notifications_count > 0 %}
                        <form method="POST" action="{% url 'users:mark-all-read' %}" class="mark-all-read-form">
                            {% csrf_token %}
                            <button type="submit" class="mark-all-read">Tout marquer comme lu</button>
                        </form>
                    {% endif %}
                </div>

                <div class="notifications-list">
                    {% if notifications %}
                        {% for notif in notifications %}
                        <div class="notification-item {% if not notif.read %}unread{% endif %}" data-notification-id="{{ notif.id }}" data-post-id="{{ notif.post_id }}">
                            <img src="{% url 'users:avatar' id=notif.actor_id %}" class="notification-avatar" alt="Avatar">
                            <div class="notification-content">
                                <div class="notification-header">
                                    <p>
                                        <strong>@{{ notif.actor_username }}</strong> a
                                        {% if notif.action_type == "like" %}
                                            aimé
                                        {% elif notif.action_type == "comment" %}
                                            commenté
                                        {% else %}
                                            interagi avec
                                        {% endif %}
                                        votre publication
                                    </p>
                                    <small>{{ notif.timestamp|date:"H:i - d M Y" }}</small>
                                </div>
                                
                                {% if notif.content %}
                                    <div class="notification-message">
                                        {% if notif.action_type == "comment" %}
                                            <i class="bi bi-chat-left-text"></i>
                                        {% else %}
                                            <i class="bi bi-heart-fill"></i>
                                        {% endif %}
                                        <p>{{ notif.content }}</p>
                                    </div>
                                {% endif %}
                                
                                <!-- Boutons d'action pour la notification -->
                                <div class="notification-actions">
                                    {% if not notif.read %}
                                    <form method="POST" action="{% url 'users:mark-notification-read' notification_id=notif.id %}" class="mark-read-form">
                                        {% csrf_token %}
                                        <button type="submit" class="mark-read-btn">
                                            <i class="bi bi-check-circle"></i> Marquer comme lu
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                                
                                <!-- Aperçu de la publication -->
                                <div class="notification-post-preview" id="post-preview-{{ notif.post_id }}">
                                    <div class="loading-indicator">Chargement...</div>
                                    <div class="post-preview-content" style="display: none;">
                                        <!-- Le contenu sera chargé dynamiquement via JavaScript -->
                                    </div>
                                    <div class="quick-reply">
                                        <form method="POST" action="{% url 'posts:comment-post' id=notif.post_id %}" class="quick-reply-form">
                                            {% csrf_token %}
                                            <input type="text" name="content" placeholder="Répondre..." class="quick-reply-input">
                                            <button type="submit" class="quick-reply-btn">
                                                <i class="bi bi-send"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                        <!-- Pagination -->
                        {% if has_more_notifications %}
                        <div class="notifications-pagination">
                            <a href="?page={{ current_page|add:1 }}" class="load-more-notifications">
                                Charger plus de notifications
                            </a>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="notification-item">
                            <div class="notification-content" style="text-align: center; padding: 2rem;">
                                <p style="color: #666;">Aucune notification pour le moment</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>


        <a href="#"><i class="bi bi-envelope">
            <div class="badge">1</div>
          </i>
          <p>conversations</p>
        </a>
        <a href="#"><i class="bi bi-palette"></i>
          <p>Theme</p>
        </a>
        <a href="#"><i class="bi bi-gear"></i>
          <p>Settings</p>
        </a>
      </nav>
      <button class="create-post-btn">Create Post</button>
    </aside>

    <section class="feed">
      <div class="stories">
        {% comment %} <div> {% endcomment %}
            <label class="story add-story" for="story-attach" url={% url "stories:story" %}>
            <img class="cover" src={% url "users:avatar" id=user.id %} alt="cover">
            <a href={% url "users:profile" id=user.id %}>
              <div class="avatar story-avatar">
                <img src={% url "users:avatar" id=user.id %} alt="profil">
              </div>
            </a>
            <p class="user firstname">Your</p>
            <p class="user lastname">Story</p>
            <input type="file" name="story-attach" class="story-attach-input" id="story-attach">
          </label>
        {% comment %} </div> {% endcomment %}

        {% for story in stories %}
          <a href={% url "stories:get-story" id=story.id %}>
            <div class="story">
              <i class="bi bi-x-circle-fill delete-post-button" url={% url "stories:delete-story" id=story.id %}></i>
              <img class="cover" src={% url "stories:story-thumbnail" id=story.id %} alt="cover">
            </div>
          </a>
        {% endfor %}
      </div>

      <form method="POST" action={% url "posts:post" %} class="post-cta-wrapper" enctype="multipart/form-data">
        {% csrf_token %}
          <div class="post-cta">
            <a href={% url "users:profile" id=user.id %}>
              <div class="avatar story-avatar">
                  <img src={% url "users:avatar" id=user.id %} alt="profil">
              </div>
            </a>
            <textarea spellcheck="false" name="content" placeholder="What's on your mind, {{user.first_name}}?"></textarea>
            <input type="file" name="image" id="attach">
            <label for="attach" class="attach-image-button">
              <i title="attach an image" class="bi bi-paperclip"></i>
            </label>
            <button type="button" class="button post-cta-button">Post</button>
          </div>
          <div class="attach-wrapper">
            <img src="" alt="attach" class="post-attach">
            <i class="bi bi-x-circle-fill discard-attach-button"></i>
          </div>
      </form>
      {% for post in posts %}
        <article class="post" id="post-{{ post.id }}">
          <div class="post-header">
            <a href={% url "users:profile" id=user.id %}>
              <div class="avatar">
                <img src={% url "users:avatar" id=user.id %} alt="profil">
              </div>
            </a>
            <div>
              <h4>{{user.first_name}} {{user.last_name}}</h4>
              <p>{{post.date|stringformat:"s"}}</p>
              {% comment %} <p>Dubai, 15 minutes ago</p> {% endcomment %}
            </div>
            <i class="bi bi-x-circle-fill delete-post-button" url={% url "posts:delete-post" id=post.id %}></i>
          </div>
          <p class="post-text">{{post.content}}</p>  <!-- This has 'white-space: pre-line', be careful then -->
         {% if post.image %}
             <img src={% url "posts:post-image" id=post.id %} alt="Post Content" class="post-image" />
         {% endif %}
          <div class="post-actions">
            <i class="like-button bi bi-heart-fill"></i>
            <p class="likes">{{ post.likes }}</p>
            <i class="bi bi-eye"></i>
            <p class="views">{{ post.views }}</p>
            <i class="see-comment-button bi bi-chat-dots"></i>
          </div>
          <div class="post-comments">
            <!-- The user write its comment here -->
            <form method="Post" action={% url "posts:comment-post" id=post.id %} class="comment-cta">
              {% csrf_token %}
              <a href={% url "users:profile" id=user.id %}>
                <div class="avatar post-avatar">
                  <img src={% url "users:avatar" id=user.id %} alt="profil">
                </div>
              </a>
              <textarea name="content" spellcheck="false" type="text" placeholder="Want to let a comment, {{ user.first_name }}?"></textarea>
              <button type="button" class="button comment-cta-button">Pin</button>
            </form>

            <!-- The other comments -->
            {% for comment in post.comments %}
                <div class="post-comment">
                  <div class="avatar post-avatar">
                    <img src={% url "users:avatar" id=comment.author %} alt="profil">
                  </div>
                  <p>{{comment.content}} </p> <!-- This has 'white-space: pre-line', be careful then -->
                </div>
            {% endfor %}
          </div>
          <!-- <p class="likes">Liked by Ernest Achiever and 2,323 others</p> -->
        </article>
      {% endfor %}
    </section>

    <div class="inside-conversation">
      <div class="header">
        <i class="bi bi-arrow-left go-back-button"></i>
        <p>{{ user.first_name }} {{ user.last_name }}</p>
        <a href={% url "users:profile" id=user.id %}>
          <div class="avatar message-avatar">
            <img src={% url "users:avatar" id=user.id %} alt="profil">
          </div>
        </a>
      </div>

      <div class="body">
        <div class="left message">
          <p class="text">
            Click one of the examples listed below to open the Shuffle Visual Editor with the UI library that uses the selected component. You don't need to remember all CSS classes
          </p>
        </div>
        <div class="right message">
          <p class="text">
          Bootstrap 5 is a popular front-end web development framework that provides many useful features and tools to create responsive, modern web applications. One of these features is the ability to create rounded corners on various HTML elements using the border-radius utility class.
          </p>
        </div>
        <div class="left message">
          <p class="text">
            Nice
          </p>
        </div>
        <div class="right message">
          <p class="text">
            Here is the picture: 👇🏿
          </p>
        </div>
        <div class="right message message-image">
          <img src={% static "images/feed-5.jpg" %} alt="">
        </div>
      </div>

      <div class="write-message">
        <label for="attach" class="attach-doc-button">
          <i title="attach an document" class="bi bi-plus-lg"></i>
        </label>
        <input type="file" name="image" id="attach">
        <textarea spellcheck="false" name="message" placeholder="Message..."></textarea>
        <i title="write-emoji" class="bi bi-emoji-smile write-emoji"></i>
        {% comment %} <div class="attach-wrapper">
          <img src="" alt="attach" class="post-attach">
          <i class="bi bi-x-circle-fill discard-attach-button"></i>
        </div> {% endcomment %}
      </div>
    </div>
  </main>
</body>
</html>